{% extends "base.html" %}
{% load truncate_filters_extra %}
{% load add_get_parameter %}

{% block js_includes %}
{{ block.super }}
<script type="text/javascript">
    var CSRF_TOKEN = '{{ csrf_token }}';

    $(document).ready(function() {
        $('input.label-editor').blur(function() {
            var e = $(this);
            
            var prevValue = e.attr('data-original');
            var curValue = e.attr('value');
            if (prevValue == curValue || e.attr('disabled')) {
                return;
            }
            
            var fullPath = e.attr('data-full-path');
            
            e.attr('disabled', 'disabled');
            e.addClass('ui-state-disabled');
                            
            $.ajax({ type: 'POST',
                     url: '{% url content.views.update_labels '/' %}' + fullPath,
                     data: {'labels': curValue},
                     headers: {'X-CSRFToken': CSRF_TOKEN},
                     dataType: 'text json' })
                .success(function(data, textStatus, jqXHR) {
                    var newLabels = data.updated_labels;
                    e.attr('data-original', newLabels);
                    e.attr('value', newLabels);
                    e.removeClass('ui-state-disabled');
                    e.removeAttr('disabled');
                })
                .error(function(jqXHR, textStatus, errorThrown) {
                    e.removeClass('ui-state-disabled');
                    e.addClass('ui-state-error');
                });
        });
    });
    
</script>
{% endblock js_includes %}

{% block title %}{{ block.super }} | Latest Content{% endblock title %}

{% block main_content %}

<div id="top_listing_bar">
    <div id="result_info">{{ content_items|length }} Result{{ content_items|pluralize }}</div>
    <div id="result_options">
		<div id="icon_or_list">
			{% if view == 'icon' %}
			    Icon | <a href = "{% url content.views.browse %}{% add_get_parameter view='list' %}">List</a>
			{% else %}
			    <a href = "{% url content.views.browse %}{% add_get_parameter view='icon' %}">Icon</a> | List
			{% endif %}
		</div>
		<div id="item_count">
			Show
			<a href="{% url content.views.browse %}{% add_get_parameter count='25' %}">25</a>,
			<a href="{% url content.views.browse %}{% add_get_parameter count='50' %}">50</a>,
			<a href="{% url content.views.browse %}{% add_get_parameter count='100' %}">100</a>
			items.
		</div>
	</div>
</div>

{% if view == 'icon' %}
    <ul class="content_list">
    {% for item in content_items %}
        <li>
        <div class="img_container">
        <a href="{% url content.views.view item.full_path|slice:"1:" %}">
        {% if item.metadata.types.original.thumbnail %}
        <img src="{% url content.views.download item.metadata.types.original.thumbnail %}"/>
        {% else %}
        <img src="{{ MEDIA_URL }}images/question.png"/>
        {% endif %}
        </a>
        </div>
        <a href="{% url content.views.view item.full_path|slice:"1:" %}">
        <span class="title">{{ item.metadata.title|truncate_chars:15 }}</span>
        </a><br>
        <span class="timeago">{{ item.timestamp|timesince }} ago </span><br>
         <a href = "{% url users.views.profile item.username %}">{{ item.username }}</a><br />
        </li>
    {% empty %}
        <li>No content!</li>
    {% endfor %}
    </ul>
{% else %}
    <div class="pagelet">
    <table>
        <thead>
            <th>Author</th>
            <th>Model</th>
            <th>Labels</th>
            <th>Time</th>
        </thead>
        {% for item in content_items %}
            <tr>
                <td><a href = "{% url users.views.profile item.username %}">{{ item.username }}</a><br /></td>
                <td>
                    {% if item.metadata.types.original.thumbnail %}
                        <img src="{% url content.views.download item.metadata.types.original.thumbnail %}" class = 'tiny_thumbnail' />
                    {% else %}
                        <img src="{{ MEDIA_URL }}images/question.png" class = 'tiny_thumbnail'/>
                    {% endif %}
                    <a href="{% url content.views.view item.full_path|slice:"1:" %}">
                    <span class="title">{{ item.metadata.title|truncate_chars:15 }}</span>
                    </a>
                </td>
                <td>
                    {% if request.user.is_superuser %}
                      <input class="label-editor ui-widget-content ui-corner-all"
                             type="text"
                             tabindex="{{ forloop.counter }}"
                             value="{{ item.metadata.labels|join:", "|default:"" }}"
                             data-original="{{ item.metadata.labels|join:", "|default:"" }}"
                             data-full-path="{{ item.full_path|slice:"1:" }}" />
                    {% else %}
                      {{ item.metadata.labels|join:", "|default:"None" }}
                    {% endif %}
                </td>
                <td>
                    <span class="timeago">{{ item.timestamp|timesince }} ago </span><br>
                </td>
            </tr>
        {% endfor %}
    </table>
    </div>
{% endif %}

<div id="listing_nav">
    <div id="prev_box">
    {% if newer_start %}
    <a href="{% url content.views.browse %}{% add_get_parameter start=newer_start,reverse='0' %}">&laquo; Previous</a>
    {% endif %}
    </div>
    <div id="next_box">
    {% if older_start %}
    <a href="{% url content.views.browse %}{% add_get_parameter start=older_start,reverse='1' %}">Next &raquo;</a>
    {% endif %}
    </div>
    &nbsp;
</div>

{% endblock main_content %}
